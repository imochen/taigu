<!DOCTYPE html>
<html>

<head>
  <title>tiles</title>
  <meta charset="utf-8">
  <meta http-equiv="imagetoolbar" content="no" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style type="text/css">
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }

    body {
      width: 100%;
      height: 100%;
      background: #000;
    }

    #map {
      position: absolute;
      height: 100%;
      width: 100%;
      background-color: #000;
    }

    #slider {
      position: absolute;
      top: 30px;
      right: 10px;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.maptiler.com/ol/v6.12.0/ol.css" type="text/css">
  <script
    src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL,fetch,Function.prototype.bind,es5&flags=always,gated&unknown=polyfill"
    type="text/javascript"></script>
  <script src="https://cdn.maptiler.com/ol/v6.12.0/ol.js" type="text/javascript"></script>

  <style>
    .tooltip {
      background-color: rgba(255, 255, 255, 0.5);
      color: black;
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 4px;
      display: none;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script type="text/javascript">
    var mapExtent = [-4096.00000000, -4096.00000000, 4096.00000000, 4096.00000000];
    var mapMinZoom = 3;
    var mapMaxZoom = 5;
    var mapMaxResolution = 1.00000000;
    var tileExtent = [-4096.00000000, -4096.00000000, 4096.00000000, 4096.00000000];
    // Proj4js definition (verify code at http://epsg.io/3857);
    // proj4.defs('EPSG:3857', '+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs');

    var margin = 3000; // 缩小的边界大小
    var newMapExtent = [
      mapExtent[0] + 2800, // left
      mapExtent[1] + 2300, // bottom
      mapExtent[2] - 2800, // right
      mapExtent[3] - 2800 // top
    ];

    var mapResolutions = [];
    for (var z = 0; z <= mapMaxZoom; z++) {
      mapResolutions.push(Math.pow(2, mapMaxZoom - z) * mapMaxResolution);
    }


    var mapTileGrid = new ol.tilegrid.TileGrid({
      extent: tileExtent,
      minZoom: mapMinZoom,
      resolutions: mapResolutions
    });

    var layer = new ol.layer.Tile({
      source: new ol.source.XYZ({
        projection: 'EPSG:3857',
        tileGrid: mapTileGrid,
        tilePixelRatio: 1.00000000,
        url: "{z}/{x}/{y}.png",
      })
    });

    var map = new ol.Map({
      target: 'map',
      layers: [
        layer,
      ],
      view: new ol.View({
        projection: ol.proj.get('EPSG:3857'),
        extent: newMapExtent,
        maxResolution: mapTileGrid.getResolution(mapMinZoom),
        constrainOnlyCenter: true,
        minZoom: mapMinZoom,
      })
    });
    map.getView().fit(newMapExtent, map.getSize());

    // 监听缩放级别变化事件
    map.getView().on('change:resolution', function (event) {
      var view = event.target;
      var currentZoom = view.getZoom(); // 获取当前缩放级别
      if (currentZoom > (mapMaxZoom - mapMinZoom)) {
        map.getView().setZoom(mapMaxZoom - mapMinZoom);
      }
      // 在这里可以添加处理缩放级别变化的逻辑
    });

    // 监听鼠标移动事件以获取当前坐标
    // map.on('pointermove', function (event) {
    //   var coordinate = event.coordinate; // 获取当前坐标
    //   var x = Math.round(coordinate[0]);
    //   var y = Math.round(coordinate[1]);
    //   var xName = x > 0 ? '东' : '西';
    //   var yName = y > 0 ? '北' : '南';
    //   console.log(`当前坐标 ${xName}: ${Math.abs(x)}, ${yName}: ${Math.abs(y)}`);
    // });

    function parsePoint(coordinate) {
      var xName = coordinate[0] > 0 ? '东' : '西';
      var yName = coordinate[1] > 0 ? '北' : '南';
      return `${xName}: ${Math.abs(coordinate[0])}, ${yName}: ${Math.abs(coordinate[1])}`;
    }


    var icons = {
      treasure: './assets/treasure.png',
      pig: './assets/pig.png',
      bean: './assets/bean.png',
      salt: './assets/salt.png',
    }


    function addMarkerWithTooltip(map, coordinate, icon, tooltipContent) {
      // 创建矢量图层用于标记
      var vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
      });

      map.addLayer(vectorLayer);
      // 创建标记要素并设置图标样式
      var iconFeature = new ol.Feature({
        geometry: new ol.geom.Point(coordinate),
      });

      var defaultScale = 0.4;
      var iconStyle = new ol.style.Style({
        image: new ol.style.Icon({
          src: icons[icon], // 图片路径
          scale: defaultScale, // 图标缩放比例
        }),
        CSSAnimation: 'rotate 2s linear infinite',
      });

      iconFeature.setStyle(iconStyle);

      // 将标记要素添加到矢量图层
      vectorLayer.getSource().addFeature(iconFeature);

      const tooltip = document.createElement('div');
      tooltip.className = 'tooltip'

      // 创建一个用于显示提示信息的覆盖物
      var tooltipOverlay = new ol.Overlay({
        element: tooltip, // HTML元素作为内容
        positioning: 'bottom-center', // 位置设置为底部中心
        offset: [0, -20], // 偏移量
        stopEvent: false, // 允许事件继续传播
      });

      map.addOverlay(tooltipOverlay);


      var selectInteraction = new ol.interaction.Select({
        layers: [vectorLayer], // 指定图层
        condition: ol.events.condition.pointerMove, // 鼠标悬停触发事件
        style: null,
      });

      map.addInteraction(selectInteraction);

      // 监听选中事件以执行悬停操作
      selectInteraction.on('select', function (event) {
        if (event.selected.length > 0) {
          var feature = event.selected[0]; // 获取选中的要素
          var featureCoordinate = feature.getGeometry().getCoordinates(); // 获取要素的坐标

          if (ol.coordinate.equals(featureCoordinate, coordinate)) {
            var text = `坐标：${parsePoint(coordinate)}`;
            if (tooltipContent) {
              text += '<br/>' + tooltipContent;
            }
            tooltipOverlay.getElement().innerHTML = text;
            tooltipOverlay.setPosition(coordinate);
            tooltipOverlay.getElement().style.display = 'block';
          } else {
            tooltipOverlay.getElement().style.display = 'none';
          }
        } else {
          tooltipOverlay.getElement().style.display = 'none';
        }
      });

      // 鼠标移出标记时隐藏提示信息
      vectorLayer.on('change', function () {
        tooltipOverlay.getElement().style.display = 'none';
      });

      // 监听地图缩放事件
      map.getView().on('change:resolution', function () {
        var zoom = map.getView().getZoom();
        var scale = defaultScale * zoom;
        if (scale < 0.4) {
          scale = 0.4
        }
        if (scale > 0.7) {
          scale = 0.7
        }
        iconStyle.getImage().setScale(scale);
      });
    }

    addMarkerWithTooltip(map, [-764, -484], 'treasure', '营地内');
    addMarkerWithTooltip(map, [-207, -1012], 'treasure', '树枝上');
    addMarkerWithTooltip(map, [1913, -1328], 'treasure', '山头上');
    addMarkerWithTooltip(map, [1121, 4], 'treasure', '半山腰');

    addMarkerWithTooltip(map, [877, -1611], 'pig', '');
    addMarkerWithTooltip(map, [988, -875], 'pig', '');

    addMarkerWithTooltip(map, [960, -480], 'bean', '');
    addMarkerWithTooltip(map, [1066, -484], 'bean', '');

    addMarkerWithTooltip(map, [859, -1836], 'salt', '两个在一起');


  </script>
</body>

</html>